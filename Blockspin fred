-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")

-- ==============================
-- Settings
-- ==============================
local LOCK_FOV = 250         -- ระยะ FOV สำหรับหาเป้าหมาย (พิกเซล)
local AIM_SMOOTH = 0.2       -- ความเร็วหมุนกล้อง (0-1)
local BEAM_COLOR = Color3.fromRGB(255,0,0)
local BEAM_WIDTH = 0.15
local HIGHLIGHT_COLOR = Color3.fromRGB(175,25,255)
local FILL_TRANSPARENCY = 0.5

-- Flags
local enableAimbot = false
local enableBeam = true
local enableHighlight = true

-- Storage
local Storage = Instance.new("Folder")
Storage.Name = "Highlight_Storage"
Storage.Parent = game:GetService("CoreGui")
local highlightConnections = {}

-- ==============================
-- Highlight ESP
-- ==============================
local function createHighlight(plr)
    if highlightConnections[plr] then return end
    local hl = Instance.new("Highlight")
    hl.Name = plr.Name
    hl.FillColor = HIGHLIGHT_COLOR
    hl.FillTransparency = FILL_TRANSPARENCY
    hl.OutlineColor = Color3.fromRGB(255,255,255)
    hl.OutlineTransparency = 0
    hl.DepthMode = Enum.HighlightDepthMode.Occluded
    hl.Parent = Storage
    if plr.Character then hl.Adornee = plr.Character end
    highlightConnections[plr] = plr.CharacterAdded:Connect(function(char)
        hl.Adornee = char
    end)
end

for _,plr in pairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then createHighlight(plr) end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then createHighlight(plr) end
end)
Players.PlayerRemoving:Connect(function(plr)
    if Storage:FindFirstChild(plr.Name) then Storage[plr.Name]:Destroy() end
    if highlightConnections[plr] then highlightConnections[plr]:Disconnect() end
end)

-- ==============================
-- Beam Tracer (ไปยังเป้าหมายใกล้ที่สุด)
-- ==============================
local currentBeam
local currentAttachment0
local currentAttachment1

local function updateBeamToTarget(target)
    if currentBeam and (not target or target.Character ~= currentBeam.Parent) then
        currentBeam:Destroy()
        currentBeam = nil
        currentAttachment0 = nil
        currentAttachment1 = nil
    end

    if not enableBeam or not target or not target.Character or not LocalPlayer.Character then return end
    local localHRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart") or LocalPlayer.Character:FindFirstChild("Head")
    local targHRP = target.Character:FindFirstChild("HumanoidRootPart") or target.Character:FindFirstChild("Head")
    if not localHRP or not targHRP then return end

    if currentBeam and currentBeam.Parent == target.Character then return end

    currentAttachment0 = Instance.new("Attachment", localHRP)
    currentAttachment1 = Instance.new("Attachment", targHRP)
    currentBeam = Instance.new("Beam")
    currentBeam.Name = "ESPBeam"
    currentBeam.Attachment0 = currentAttachment0
    currentBeam.Attachment1 = currentAttachment1
    currentBeam.Color = ColorSequence.new(BEAM_COLOR)
    currentBeam.Width0 = BEAM_WIDTH
    currentBeam.Width1 = BEAM_WIDTH
    currentBeam.FaceCamera = true
    currentBeam.Parent = target.Character
end

-- ==============================
-- หาเป้าหมายใกล้ที่สุด
-- ==============================
local function GetClosestTarget()
    local closest
    local closestDist = math.huge
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("Head")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                    if dist < closestDist and dist <= LOCK_FOV then
                        closestDist = dist
                        closest = plr
                    end
                end
            end
        end
    end
    return closest
end

-- ==============================
-- Aimbot (หมุนกล้องไปยังเป้าหมาย)
-- ==============================
local function AimAtTarget(target)
    if not enableAimbot or not target or not target.Character then return end
    local hrp = target.Character:FindFirstChild("HumanoidRootPart") or target.Character:FindFirstChild("Head")
    if not hrp then return end
    local targetPos = hrp.Position
    local dir = (targetPos - Camera.CFrame.Position)
    if dir.Magnitude > 0 then
        local lookCFrame = CFrame.new(Camera.CFrame.Position, Camera.CFrame.Position + dir.Unit)
        Camera.CFrame = Camera.CFrame:Lerp(lookCFrame, math.clamp(AIM_SMOOTH,0,1))
    end
end

-- ==============================
-- RenderStepped Loop
-- ==============================
RunService.RenderStepped:Connect(function()
    local target = GetClosestTarget()
    if enableBeam then updateBeamToTarget(target) end
    AimAtTarget(target)
end)

-- ==============================
-- Input: คลิกขวา toggle Aimbot, ปุ่มอื่น toggle features
-- ==============================
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        enableAimbot = not enableAimbot
    elseif input.KeyCode == Enum.KeyCode.H then
        enableHighlight = not enableHighlight
        for _,hl in pairs(Storage:GetChildren()) do
            if hl:IsA("Highlight") then hl.Enabled = enableHighlight end
        end
    elseif input.KeyCode == Enum.KeyCode.B then
        enableBeam = not enableBeam
        if not enableBeam and currentBeam then
            currentBeam:Destroy()
            currentBeam = nil
        end
    end
end)
