-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")

-- ==============================
-- Settings
-- ==============================
local LOCK_FOV = 250
local PREDICTION = 0.1
local AIM_SMOOTH = 0.2 -- ความเรียบของการหมุนกล้อง (0-1)

-- Colors & Thickness
local HIGHLIGHT_COLOR = Color3.fromRGB(175,25,255)
local FILL_TRANSPARENCY = 0.5
local TRACER_COLOR = Color3.fromRGB(255,0,0)
local TRACER_THICKNESS = 2

-- RemoteEvent ของเกม (เปลี่ยนให้ตรงเกม)
local FireEventName = "FireEvent"
local FireEvent = ReplicatedStorage:FindFirstChild(FireEventName)

-- ==============================
-- GUI Variables / Flags
-- ==============================
local showHighlight = true
local showTracers = true
local enableAimbot = false     -- จะถูกเปิดเมื่อกดคลิกขวา
local enableSilentAim = true

-- ==============================
-- Storage
-- ==============================
local Storage = Instance.new("Folder")
Storage.Name = "Highlight_Storage"
Storage.Parent = game:GetService("CoreGui")

local tracerLines = {}
local highlightConnections = {}

-- ==============================
-- Highlight Function
-- ==============================
local function HighlightPlayer(plr)
    local highlight = Instance.new("Highlight")
    highlight.Name = plr.Name
    highlight.FillColor = HIGHLIGHT_COLOR
    highlight.FillTransparency = FILL_TRANSPARENCY
    highlight.OutlineColor = Color3.fromRGB(255,255,255)
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.Occluded
    highlight.Parent = Storage

    if plr.Character then
        highlight.Adornee = plr.Character
    end

    highlightConnections[plr] = plr.CharacterAdded:Connect(function(char)
        highlight.Adornee = char
    end)
end

for _,plr in pairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then HighlightPlayer(plr) end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then HighlightPlayer(plr) end
end)

Players.PlayerRemoving:Connect(function(plr)
    if Storage:FindFirstChild(plr.Name) then Storage[plr.Name]:Destroy() end
    if highlightConnections[plr] then highlightConnections[plr]:Disconnect() end
    if tracerLines[plr] then tracerLines[plr]:Destroy() end
end)

-- ==============================
-- Tracers Setup
-- ==============================
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

local function CreateTracer(plr)
    local line = Instance.new("Frame")
    line.Size = UDim2.new(0, TRACER_THICKNESS, 0, 0)
    line.BackgroundColor3 = TRACER_COLOR
    line.BorderSizePixel = 0
    line.AnchorPoint = Vector2.new(0.5, 0)
    line.Visible = true
    line.Parent = screenGui
    tracerLines[plr] = line
end

for _,plr in pairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then CreateTracer(plr) end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then CreateTracer(plr) end
end)

-- ==============================
-- Target Lock + Silent Aim
-- ==============================
local function GetClosestTarget()
    local closestPlayer = nil
    local closestDistance = math.huge
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("Head")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                    if dist < closestDistance and dist <= LOCK_FOV then
                        closestDistance = dist
                        closestPlayer = plr
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function ShootTarget(target)
    if enableSilentAim and FireEvent and target and target.Character then
        local hrp = target.Character:FindFirstChild("HumanoidRootPart") or target.Character:FindFirstChild("Head")
        if hrp then
            local predictedPos = hrp.Position + (hrp.Velocity * PREDICTION)
            -- ส่งตำแหน่งไปให้ Server ยิง (ขึ้นกับ RemoteEvent เกม)
            FireEvent:FireServer(predictedPos)
        end
    end
end

local function AimAtTarget(target)
    if enableAimbot and target and target.Character and Camera then
        local hrp = target.Character:FindFirstChild("HumanoidRootPart") or target.Character:FindFirstChild("Head")
        if hrp then
            local targetPos = hrp.Position + hrp.Velocity * PREDICTION
            local dir = (targetPos - Camera.CFrame.Position)
            if dir.Magnitude > 0 then
                local lookCFrame = CFrame.new(Camera.CFrame.Position, Camera.CFrame.Position + dir.Unit)
                Camera.CFrame = Camera.CFrame:Lerp(lookCFrame, math.clamp(AIM_SMOOTH, 0, 1))
            end
        end
    end
end

-- ==============================
-- RenderStepped Update
-- ==============================
RunService.RenderStepped:Connect(function()
    local centerX, centerY = Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2
    local target = GetClosestTarget()

    -- Update Tracers
    for plr, line in pairs(tracerLines) do
        if plr.Character and showTracers then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("Head")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    line.Visible = true
                    local startPos = Vector2.new(centerX, centerY)
                    local endPos = Vector2.new(screenPos.X, screenPos.Y)
                    local distance = (endPos - startPos).Magnitude
                    line.Size = UDim2.new(0, TRACER_THICKNESS, 0, distance)
                    local angle = math.atan2(endPos.Y - startPos.Y, endPos.X - startPos.X)
                    line.Rotation = math.deg(angle) + 90
                    line.Position = UDim2.new(0, startPos.X, 0, startPos.Y)
                else
                    line.Visible = false
                end
            else
                line.Visible = false
            end
        else
            if line then line.Visible = false end
        end
    end

    -- Aimbot (หมุนกล้องเมื่อ enableAimbot = true)
    AimAtTarget(target)

    -- Silent Aim ยิง
    ShootTarget(target)
end)

-- ==============================
-- Input Handling: คลิกขวาเพื่อ Aimbot (hold) และปุ่มอื่น ๆ สำหรับ toggle
-- ==============================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    -- คลิกขวาเริ่มเปิด Aimbot (hold)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        enableAimbot = true
    end

    -- Key toggles
    if input.KeyCode == Enum.KeyCode.H then
        showHighlight = not showHighlight
        for _,hl in pairs(Storage:GetChildren()) do
            if hl:IsA("Highlight") then
                hl.Enabled = showHighlight
            end
        end
    elseif input.KeyCode == Enum.KeyCode.T then
        showTracers = not showTracers
    elseif input.KeyCode == Enum.KeyCode.S then
        enableSilentAim = not enableSilentAim
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    -- ปล่อยคลิกขวา = ปิด Aimbot
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        enableAimbot = false
    end
end)

-- หมายเหตุ: คุณสามารถกด H/T/S เพื่อ สลับ Highlight/Tracers/SilentAim ตามต้องการ
