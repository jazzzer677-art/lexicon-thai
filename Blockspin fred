-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")

-- ==============================
-- Settings
-- ==============================
local LOCK_FOV = 250
local PREDICTION = 0.1
local AIM_SMOOTH = 0.2 -- ความเรียบของการหมุนกล้อง

-- Colors
local HIGHLIGHT_COLOR = Color3.fromRGB(175,25,255)
local FILL_TRANSPARENCY = 0.5
local BEAM_COLOR = Color3.fromRGB(255,0,0)
local BEAM_WIDTH = 0.15

-- RemoteEvent ของเกม (เปลี่ยนให้ตรงเกม)
local FireEventName = "FireEvent"
local FireEvent = ReplicatedStorage:FindFirstChild(FireEventName)

-- ==============================
-- Flags / GUI
-- ==============================
local showHighlight = true
local enableAimbot = false     -- hold คลิกขวา
local enableSilentAim = true
local enableBeamTracers = true

-- ==============================
-- Highlight Function
-- ==============================
local Storage = Instance.new("Folder")
Storage.Name = "Highlight_Storage"
Storage.Parent = game:GetService("CoreGui")

local highlightConnections = {}

local function HighlightPlayer(plr)
    local highlight = Instance.new("Highlight")
    highlight.Name = plr.Name
    highlight.FillColor = HIGHLIGHT_COLOR
    highlight.FillTransparency = FILL_TRANSPARENCY
    highlight.OutlineColor = Color3.fromRGB(255,255,255)
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.Occluded
    highlight.Parent = Storage

    if plr.Character then
        highlight.Adornee = plr.Character
    end

    highlightConnections[plr] = plr.CharacterAdded:Connect(function(char)
        highlight.Adornee = char
    end)
end

for _,plr in pairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then HighlightPlayer(plr) end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then HighlightPlayer(plr) end
end)

Players.PlayerRemoving:Connect(function(plr)
    if Storage:FindFirstChild(plr.Name) then Storage[plr.Name]:Destroy() end
    if highlightConnections[plr] then highlightConnections[plr]:Disconnect() end
end)

-- ==============================
-- Beam Tracers Function
-- ==============================
local function AssignTracers()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local PlayerChar = workspace:FindFirstChild(player.Name)
            local LocalChar = LocalPlayer.Character
            if not PlayerChar or not LocalChar or not LocalChar:FindFirstChild("HumanoidRootPart") then
                return
            end

            local beam
            if PlayerChar:FindFirstChild("ESPBeam") then
                beam = PlayerChar:FindFirstChild("ESPBeam")
                if beam then
                    beam.Enabled = enableBeamTracers
                    if not beam.Attachment0 then
                        local attachment0 = Instance.new("Attachment", LocalChar:WaitForChild("HumanoidRootPart"))
                        beam.Attachment0 = attachment0
                    end
                end
            end

            if not beam and enableBeamTracers then
                local attachment0 = Instance.new("Attachment", LocalChar:WaitForChild("HumanoidRootPart"))
                local attachment1 = Instance.new("Attachment", PlayerChar:WaitForChild("HumanoidRootPart"))

                beam = Instance.new("Beam")
                beam.Name = "ESPBeam"
                beam.Attachment0 = attachment0
                beam.Attachment1 = attachment1
                beam.Color = ColorSequence.new(BEAM_COLOR)
                beam.FaceCamera = true
                beam.Width0 = BEAM_WIDTH
                beam.Width1 = BEAM_WIDTH
                beam.Parent = PlayerChar
            end
        end
    end
end

AssignTracers()

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        wait(1)
        AssignTracers()
    end)
end)

LocalPlayer.CharacterAdded:Connect(function()
    wait(1)
    AssignTracers()
end)

-- ==============================
-- Target Lock + Silent Aim + Aimbot
-- ==============================
local function GetClosestTarget()
    local closestPlayer = nil
    local closestDistance = math.huge
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("Head")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                    if dist < closestDistance and dist <= LOCK_FOV then
                        closestDistance = dist
                        closestPlayer = plr
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function ShootTarget(target)
    if enableSilentAim and FireEvent and target and target.Character then
        local hrp = target.Character:FindFirstChild("HumanoidRootPart") or target.Character:FindFirstChild("Head")
        if hrp then
            local predictedPos = hrp.Position + (hrp.Velocity * PREDICTION)
            FireEvent:FireServer(predictedPos)
        end
    end
end

local function AimAtTarget(target)
    if enableAimbot and target and target.Character and Camera then
        local hrp = target.Character:FindFirstChild("HumanoidRootPart") or target.Character:FindFirstChild("Head")
        if hrp then
            local targetPos = hrp.Position + hrp.Velocity * PREDICTION
            local dir = (targetPos - Camera.CFrame.Position)
            if dir.Magnitude > 0 then
                local lookCFrame = CFrame.new(Camera.CFrame.Position, Camera.CFrame.Position + dir.Unit)
                Camera.CFrame = Camera.CFrame:Lerp(lookCFrame, math.clamp(AIM_SMOOTH,0,1))
            end
        end
    end
end

-- ==============================
-- RenderStepped Update
-- ==============================
